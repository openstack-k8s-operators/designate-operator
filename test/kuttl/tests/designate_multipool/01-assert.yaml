apiVersion: designate.openstack.org/v1beta1
kind: Designate
metadata:
  name: designate
spec:
  databaseInstance: openstack
  databaseAccount: designate
  serviceUser: designate
  secret: osp-secret
  preserveJobs: false
  designateAPI:
    replicas: 1
  designateCentral:
    replicas: 1
  designateWorker:
    replicas: 1
  designateProducer:
    replicas: 1
  designateUnbound:
    replicas: 1
  customServiceConfig: |
    [DEFAULT]
    debug = true
status:
  designateBackendbind9ReadyCount: 2
---
# Verify that 2 StatefulSets are created for the 2 pools
# Pool 0 uses the base name (designate-backendbind9) for backwards compatibility
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: designate-backendbind9
  labels:
    service: designate-backendbind9
status:
  readyReplicas: 1
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: designate-backendbind9-pool1
  labels:
    service: designate-backendbind9
status:
  readyReplicas: 1
---
# Verify pool-specific services are created
# Pool 0 services use base name pattern (designate-backendbind9-N)
apiVersion: v1
kind: Service
metadata:
  name: designate-backendbind9-0
---
apiVersion: v1
kind: Service
metadata:
  name: designate-backendbind9-pool1-0
---
# Verify per-pool bind IP ConfigMaps are created with RNDC key mappings
apiVersion: v1
kind: ConfigMap
metadata:
  name: designate-bind-ip-map
data:
  rndc_key_0: rndc-key-0
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: designate-bind-ip-map-pool1
data:
  rndc_key_0: rndc-key-1
---
# Verify TSIG secret is created for non-default pools
apiVersion: v1
kind: Secret
metadata:
  name: designate-backendbind9-tsig
  labels:
    service: designate-backendbind9
    component: designate-backendbind9
type: Opaque
---
# Verify pools.yaml ConfigMap uses multipool NS records
apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 600
commands:
  - script: |
      # Verify pools.yaml uses multipool ConfigMap NS records
      # Should use ns1.example.org (from multipool CM), not ns1.example.com (from CR)
      POOLS_YAML=$(oc get configmap designate-pools-yaml-config-map -n $NAMESPACE -o jsonpath='{.data.pools-yaml-content}')
      if echo "$POOLS_YAML" | grep -q "ns1.example.org"; then
        echo "SUCCESS: Initial multipool deployment uses ConfigMap NS records (ns1.example.org)"
      else
        echo "ERROR: Multipool mode should use ConfigMap NS records (ns1.example.org), not CR NS records"
        echo "Pools YAML content:"
        echo "$POOLS_YAML"
        exit 1
      fi
