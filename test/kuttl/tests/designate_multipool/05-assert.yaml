apiVersion: designate.openstack.org/v1beta1
kind: Designate
metadata:
  name: designate
status:
  designateBackendbind9ReadyCount: 2
---
# Verify that only 2 StatefulSets remain (default and pool1)
# Pool 0 uses the base name (designate-backendbind9) for backwards compatibility
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: designate-backendbind9
  labels:
    service: designate-backendbind9
status:
  readyReplicas: 1
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: designate-backendbind9-pool1
  labels:
    service: designate-backendbind9
status:
  readyReplicas: 1
---
# Verify that ALL pool2 resources are deleted (prevent resource leaks)
# Also verify that the pool list job was created and executed for pool validation
apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 120
commands:
  - script: |
      set -e
      ERRORS=0

      echo "=== Verifying Pool List Job for Pool Removal Validation ==="

      # 1. Verify pool list job was created during pool removal validation
      if oc get job designate-pool-list -n $NAMESPACE 2>/dev/null; then
        echo "✓ Pool list job exists (created for pool validation)"

        # Check job completion status
        jobConditionType=$(oc get job designate-pool-list -n $NAMESPACE -o jsonpath='{.status.conditions[0].type}' 2>/dev/null || echo "")
        if [ "$jobConditionType" = "Complete" ] || [ "$jobConditionType" = "SuccessCriteriaMet" ]; then
          echo "✓ Pool list job completed successfully (status: $jobConditionType)"
        else
          echo "ERROR: Pool list job did not complete successfully (status: $jobConditionType)"
          ERRORS=$((ERRORS + 1))
        fi
      else
        echo "ERROR: Pool list job not found (should have been created for pool validation)"
        ERRORS=$((ERRORS + 1))
      fi

      echo ""
      echo "=== Verifying all pool2 resources are deleted ==="

      # 1. Check that pool2 StatefulSet no longer exists
      if oc get statefulset designate-backendbind9-pool2 -n $NAMESPACE 2>/dev/null; then
        echo "ERROR: designate-backendbind9-pool2 StatefulSet still exists after pool removal"
        ERRORS=$((ERRORS + 1))
      else
        echo "✓ Pool2 StatefulSet deleted"
      fi

      # 2. Check that pool2 services no longer exist
      # Services follow pattern: designate-backendbind9-pool2-{0,1,2,...}
      pool2_services=$(oc get services -n $NAMESPACE 2>/dev/null | grep "designate-backendbind9-pool2-" | wc -l)
      if [ "$pool2_services" -gt 0 ]; then
        echo "ERROR: Found $pool2_services pool2 services that should be deleted"
        oc get services -n $NAMESPACE | grep "designate-backendbind9-pool2-"
        ERRORS=$((ERRORS + 1))
      else
        echo "✓ Pool2 services deleted"
      fi

      # 3. Check that pool2-specific ConfigMap no longer exists
      if oc get configmap designate-bind-ip-map-pool2 -n $NAMESPACE 2>/dev/null; then
        echo "ERROR: designate-bind-ip-map-pool2 ConfigMap still exists after pool removal"
        ERRORS=$((ERRORS + 1))
      else
        echo "✓ Pool2 ConfigMap deleted"
      fi

      # 4. Verify TSIG secret still exists (shared by pool1, should NOT be deleted)
      if ! oc get secret designate-backendbind9-tsig -n $NAMESPACE 2>/dev/null; then
        echo "ERROR: TSIG secret was incorrectly deleted (pool1 still needs it)"
        ERRORS=$((ERRORS + 1))
      else
        echo "✓ TSIG secret retained (still needed by pool1)"
      fi

      if [ "$ERRORS" -gt 0 ]; then
        echo "FAILED: Found $ERRORS orphaned resources after pool2 removal"
        exit 1
      fi

      echo "SUCCESS: All pool2 resources were cleaned up properly"
      echo "  - StatefulSet: deleted"
      echo "  - Services: deleted"
      echo "  - ConfigMap: deleted"
      echo "  - TSIG secret: retained (shared resource)"
      exit 0
